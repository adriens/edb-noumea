---
title: "Qualité des Eaux de Baignade à Nouméa"
author: "Adrien SALES | $\\mathbb{X}$ @rastadidi | dev.to/adriens"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  pdf_document:
    latex_engine: xelatex
    toc: false
  word_document:
    toc: false
  html_document:
    toc: false
    df_print: paged
keywords:
  - qualité de l’eau
  - Nouméa
  - plages
  - analyses bactériologiques
  - Escherichia coli
  - entérocoques
  - rapport environnemental
  - données publiques
  - RMarkdown
  - visualisation
  - santé publique
  - Nouvelle-Calédonie
  - open data
  - pollution
  - baignade
  - monitoring environnemental
  - data science
  - analyse statistique
  - démo R
---


\begin{abstract}
Ce rapport généré de manière automatique - à l'aide de logiciel libre - présente une synthèse claire et visuelle
de la qualité des eaux de baignade à Nouméa, basée sur les derniers relevés disponibles.

Il propose une vue d’ensemble originale du statut sanitaire officiel des plages
(autorisation de la baignade et relevés), ainsi que des analyses détaillées des
 concentrations en bactéries E. coli et Enterocoques par point de prélèvement.\\

L’objectif - prinicpalement à but de sensiblisation -  est d’informer efficacement les usagers
sur les zones de baignade les plus sûres \textbf{mais avant tout d'illustrer très concrétement l'intérêt
de partager ces données de manière interopérable (dataset, API, SDK)... et donc permettre aux citoyens
de contribuer avec leurs compétences au développement de services à valeur ajoutée pour la communauté en
rendant la ville de Nouméa plus "smart" et résiliente.}
\end{abstract}

\begin{figure}[ht]
  \centering
  \includegraphics[width=0.35\textwidth]{drs-eaux-baignade.jpg}
\end{figure}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Installation des packages nécessaires s'ils ne sont pas déjà installés
packages <- c("rmarkdown", "duckdb", "DBI", "dplyr", "ggplot2", "knitr")
new_packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

# Chargement des librairies
library(duckdb)
library(DBI)
library(dplyr)
library(ggplot2)
library(knitr)
```


\section{Introduction}

Deux indicateurs bactériologiques sont pris en compte pour évaluer la qualité de l'eau :

- **E. coli** (exprimé en UFC/100ml), indicateur principal de contamination fécale d'origine humaine ou animale.
- **Enterocoques** (exprimés en UFC/100ml), également utilisés pour détecter la contamination fécale, notamment en milieu marin.

Les seuils suivants sont utilisés pour définir le statut de la baignade selon la concentration en E. coli :

*   **< 250 UFC/100ml :** Baignade **Sûre**.
*   **250 à 500 UFC/100ml :** **Vigilance requise**.
*   **> 500 UFC/100ml :** Baignade **Déconseillée**.

---


```{r load_data}
# Chemin vers la base de données
db_path <- "edb-noumea.duckdb"

# Connexion à la base de données DuckDB
con <- dbConnect(duckdb(), dbdir = db_path, read_only = TRUE)

# --- ATTENTION ---

# Utilisation de la table 'details' et adaptation des noms de colonnes
table_name <- "details"

if (dbExistsTable(con, table_name)) {
  query <- paste("SELECT * FROM", table_name)
  donnees <- dbGetQuery(con, query)
  
  donnees <- donnees %>%
    mutate(
      date_releve = as.Date(date),
      nom_plage = site,
      valeur_ecoli = e_coli_npp_100ml,
      statut = case_when(
        valeur_ecoli < 250 ~ "Sûre",
        valeur_ecoli >= 250 & valeur_ecoli <= 500 ~ "Vigilance requise",
        valeur_ecoli > 500 ~ "Baignade déconseillée"
      )
    ) %>%
    mutate(statut = factor(statut, levels = c("Sûre", "Vigilance requise", "Baignade déconseillée")))

} else {
  donnees <- data.frame()
  stop(paste("ERREUR : La table '", table_name, "' n'a pas été trouvée."))
}

dbDisconnect(con, shutdown = TRUE)
```
\newpage
\section{Statut sanitaire officiel par plage}

Le tableau ci-dessous présente le \href{https://www.noumea.nc/noumea-pratique/salubrite-publique/qualite-eaux-baignade}{statut sanitaire officiel de chaque plage},
tel qu'extrait de la base de données.

```{r synthese_statuts_resume, echo=FALSE}
# Connexion à la base et extraction de la table 'resume'
db_path <- "edb-noumea.duckdb"
con <- dbConnect(duckdb(), dbdir = db_path, read_only = TRUE)
if (dbExistsTable(con, "resume")) {
  resume <- dbReadTable(con, "resume")
  resume <- resume %>%
    select(Plage = plage, `Statut sanitaire` = etat_sanitaire) %>%
    arrange(Plage)
  kable(resume, caption = "Statut sanitaire officiel par plage.", booktabs = TRUE)
} else {
  cat("Aucune donnée disponible dans la table 'resume'.")
}
dbDisconnect(con, shutdown = TRUE)
```

\newpage
\section{Concentrations moyennes}

```{r graph_concentration_ecoli, echo=FALSE, fig.cap="Concentration moyenne d'E. coli par point de prélèvement"}
if (exists("donnees") && nrow(donnees) > 0) {
  donnees_bar <- donnees %>%
    group_by(point_de_prelevement) %>%
    summarise(moyenne_ecoli = mean(valeur_ecoli, na.rm = TRUE)) %>%
    arrange(desc(moyenne_ecoli))
  ggplot(donnees_bar, aes(x = reorder(point_de_prelevement, -moyenne_ecoli), y = moyenne_ecoli)) +
    geom_bar(stat = "identity", fill = "steelblue", alpha = 0.8) +
    geom_hline(yintercept = 250, linetype = "dashed", color = "orange") +
    geom_hline(yintercept = 500, linetype = "dashed", color = "red") +
    labs(
      title = "Concentration moyenne d'E. coli par point de prélèvement",
      x = "Point de prélèvement",
      y = "E. coli moyen (UFC/100ml)"
    ) +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7)
    )
} else {
  cat("Aucune donnée disponible pour le graphique.")
}
```


```{r graph_concentration_enterocoques, echo=FALSE, fig.cap="Concentration moyenne d'Enterocoques par point de prélèvement"}
if (exists("donnees") && nrow(donnees) > 0) {
  donnees_bar_ent <- donnees %>%
    group_by(point_de_prelevement) %>%
    summarise(moyenne_ent = mean(enterocoques_npp_100ml, na.rm = TRUE)) %>%
    arrange(desc(moyenne_ent))
  ggplot(donnees_bar_ent, aes(x = reorder(point_de_prelevement, -moyenne_ent), y = moyenne_ent)) +
    geom_bar(stat = "identity", fill = "darkorchid", alpha = 0.8) +
    labs(
      title = "Concentration moyenne d'Enterocoques par point de prélèvement",
      x = "Point de prélèvement",
      y = "Enterocoques moyen (UFC/100ml)"
    ) +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 7)
    )
} else {
  cat("Aucune donnée disponible pour le graphique.")
}
```

\newpage
\section{Détails des prélèvements}

Le tableau ci-dessous présente les données détaillées issues de la table `details` :

```{r tableau_details, echo=FALSE}
if (exists("donnees") && nrow(donnees) > 0) {
  library(kableExtra)
  donnees_affichees <- donnees %>%
    select(
      `Point de prélèvement` = desc_point_prelevement,
      Date = date_releve,
      `E. coli (NPP/100mL)` = e_coli_npp_100ml,
      `Entérocoques (NPP/100mL)` = enterocoques_npp_100ml
    )
  donnees_affichees <- donnees_affichees %>%
    mutate(
      Date = format(Date, "%Y-%m-%d"),
      `Point de prélèvement` = stringr::str_to_sentence(`Point de prélèvement`)
    ) %>%
    arrange(desc(`E. coli (NPP/100mL)`))
  # Coloration des lignes selon la valeur d'E. coli
  lignes_rouges <- which(donnees_affichees$`E. coli (NPP/100mL)` > 500)
  lignes_orange <- which(donnees_affichees$`E. coli (NPP/100mL)` >= 250 & donnees_affichees$`E. coli (NPP/100mL)` <= 500)
  kable(donnees_affichees, caption = "Données détaillées des prélèvements (table details)", booktabs = TRUE) %>%
    kable_styling(full_width = FALSE) %>%
    row_spec(lignes_rouges, background = "#ffcccc") %>%
    row_spec(lignes_orange, background = "#fff2cc")
} else {
  cat("Aucune donnée disponible dans la table 'details'.")
}
```

\newpage
\section{Valeurs seuils eau de baignade en mer \texttt{DASS-NC}}

Cf les \href{https://dass.gouv.nc/sites/default/files/atoms/files/valeurs_seuils_eau_de_baignade_en_mer_dass-nc.pdf}{Valeurs seuils eau de baignade en mer} produites par la \href{https://dass.gouv.nc/}{\texttt{DASS-NC}}.

\begin{quote}
La Direction des Affaires Sanitaires et Sociales de Nouvelle-Calédonie utilise plusieurs valeurs seuils pour interpréter les résultats d'analyse d'une eau de baignade en mer et informe la municipalité afin qu'elle prenne des mesures pour garantir la protection des baigneurs. Ces valeurs figurent dans le tableau ci-dessous :
\end{quote}

\begin{table}[H]
\centering
\begin{tabular}{|l|c|c|p{6cm}|}
\hline
	\textbf{Qualification} & \textbf{E. coli (UFC/100mL)} & \textbf{Entér. (UFC/100mL)} & \textbf{Risques et recommandations sanitaires} \\
\hline
\cellcolor{blue!10} Bon & $\leq 100$ $^*$ & $\leq 100$ $^*$ & Eau de bonne qualité. \textbf{Risque sanitaire très faible} \\
\cellcolor{green!10} Moyen & $> 100$ et $< 1000$ $^{**}$ & $> 100$ et $< 370$ $^{**}$ & Qualité des eaux moyenne. \textbf{Le risque sanitaire existe mais reste cependant modéré} \\
\cellcolor{brown!10} Mauvais & $> 1000$ & $> 370$ & Mauvaise qualité des eaux. Risque sanitaire élevé. \textbf{Baignade déconseillée} \\
\cellcolor{red!10} Fermeture obligatoire & $> 2000$ $^{***}$ & Pas de valeur impérative & Risque sanitaire avéré. \textbf{La baignade doit être interdite} \\
\hline
\end{tabular}
\caption{Valeurs seuils eau de baignade en mer selon la DASS-NC}
\end{table}


\vspace{1em}

\noindent\textbf{$^*$ Valeurs guides}~: Indiquées dans la réglementation néo-calédonienne dans la délibération 23/CP du 1er juin 2010 et l'arrêté \href{https://www.noumea.nc/sites/default/files/publications/2022-3671-arrete-interdisant-temporairement-toutes-baignades-activites-nautiques-peche-plan-eau-pl.pdf}{n°2010-3055/GNC} du 1 septembre 2010. Une valeur-guide est, conformément aux recommandations de l'OMS, un niveau de concentration de polluants dans un milieu (eau, air, air intérieur, sol) fixé dans le but d'éviter, de prévenir ou de réduire les effets nocifs sur la santé humaine, à atteindre et à ne plus dépasser dans la mesure du possible. En dessous de ce seuil, l'eau est considérée comme étant de bonne qualité.

\vspace{0.5em}

\noindent\textbf{$^{**}$ Valeurs AFSSET}~: Définies par l'Agence française de sécurité sanitaire de l'environnement et du travail, devenue Anses, l'Agence nationale de sécurité sanitaire de l'alimentation, de l'environnement et du travail. Ces valeurs sont proposées dans le rapport "valeurs seuils échantillon unique pour les eaux de baignade : étude de faisabilité méthodologique" de septembre 2007 repris également par le ministère français en charge de la santé pour qualifier une pollution de l'eau de baignade. Ces seuils sont une référence pour la mise en place, par la municipalité responsable de l'eau de baignade, des procédures de gestion des pollutions et pour qualifier la qualité bactériologique d'une eau de baignade.

\vspace{0.5em}

\noindent\textbf{$^{***}$ Valeur impérative}~: Indiquées dans la réglementation néo-calédonienne dans la délibération 23/CP du 1er juin 2010 et l'arrêté \href{https://www.noumea.nc/sites/default/files/publications/2022-3671-arrete-interdisant-temporairement-toutes-baignades-activites-nautiques-peche-plan-eau-pl.pdf}{n° 2010-3055/GNC} du 14 septembre 2010. Au-delà de la valeur impérative, la baignade doit être interdite.



\newpage
\section{Ressources}

\textbf{Sources et outils utilisés pour ce rapport :}

- \href{https://www.kaggle.com/code/adriensales/qualit-eaux-de-baignade-noum-a}{Notebook Kaggle : Qualité des eaux de baignade Nouméa}
- \href{https://pypi.org/project/edb-noumea/}{Package Python \texttt{edb-noumea} sur PyPI}
- \href{https://github.com/adriens/edb-noumea/}{Code source sur GitHub}
- \href{https://www.youtube.com/watch?v=suVkKJ_nNGI}{Démo vidéo YouTube}
- \href{https://dev.to/adriens/series/23296}{Nouméa Smart City Series' Articles sur dev.to}
- \href{https://www.noumea.nc/noumea-pratique/salubrite-publique/qualite-eaux-baignade}{Site officiel de la Ville de Nouméa}

Ces ressources ont pour ambition de permettre de prendre en main le code, susciter l'envie d'explorer,
d'analyser et de réutiliser les données de qualité des eaux de baignade à Nouméa.
